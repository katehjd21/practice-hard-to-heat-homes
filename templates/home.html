{% extends "base.html" %}
{% block content %}

  <div class="govuk-grid-row">
    <div>
      <h1 class="govuk-heading-l">Hard to Heat Homes</h1>
      <div id="map" style="height: 250px; margin-bottom: 20px;"></div>
      <table class="govuk-table govuk-table--small-text-until-tablet" id="data">
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header no-sort">Address</th> 
            <th scope="col" class="govuk-table__header" title="Low 0-4 High">Hard To Heat Score:<br>(easy) 0 - 4 (hard)</th>
            <th scope="col" class="govuk-table__header no-sort">Details</th>
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          {% for prop in properties %}
          <tr class="govuk-table__row">
            <td class="govuk-table__cell" id="{{ prop.uprn }}">
              {% if not prop.address %}
                <a onclick="setAddress('{{ prop.uprn }}','{{ prop.uprn }}', '{{ key }}')" style="color:blue; text-decoration: underline">Click for address</a>
              {% else %}
                {{ prop.address }}
              {% endif %}
            </td>
            <td class="govuk-table__cell">{{ prop.score }}</td>
            <td class="govuk-table__cell">
              <a class="govuk-button govuk-button--secondary" href="{{ url_for('property', uprn=prop.uprn) }}" style="color:black; text-decoration:none">Details</a>
            </td>
          </tr>
          {% endfor %}
        </tbody> 
      </table>
    </div>
  </div>

  {% block scripts %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.min.js" crossorigin="anonymous"></script>
  <script defer>
    $(document).ready(function() {
      $("#data").DataTable({
        paging: true,
        pageLength: 25,
        order: [],
        ordering: true,
        columnDefs: [{
          orderable: false,
          targets: "no-sort"
        }]
      });
    });
  </script>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<script defer>
const markersDict = {}; // store markers by UPRN

async function initMap() {
    const map = L.map('map').setView([{{ properties[0].lat }}, {{ properties[0].long }}], 13);
    
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const scoreIcons = {
    1: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    2: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    3: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    4: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    })
};

const scoreIconsHover = {
    1: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [30, 51],
        iconAnchor: [17, 56],
        popupAnchor: [1, -34],
        shadowSize: [56, 56]
    }),
        2: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [30, 51],
        iconAnchor: [17, 56],
        popupAnchor: [1, -34],
        shadowSize: [56, 56]
    }),
    3: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [30, 51],
        iconAnchor: [17, 56],
        popupAnchor: [1, -34],
        shadowSize: [56, 56]
    }),
    4: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [30, 51],
        iconAnchor: [17, 56],
        popupAnchor: [1, -34],
        shadowSize: [56, 56]
    })
};


    const props = [
        {% for prop in properties %}
            {% if prop.lat and prop.long %}
            {
                uprn: "{{ prop.uprn }}",
                lat: {{ prop.lat }},
                long: {{ prop.long }},
                score: {{ prop.score }}
            },
            {% endif %}
        {% endfor %}
    ];

    const markersPositions = [];

    for (const prop of props) {
        const marker = L.marker([prop.lat, prop.long], {
        icon: scoreIcons[prop.score] || scoreIcons[1] 
    }).addTo(map);


        markersDict[prop.uprn] = marker;

        marker.on('mouseover', function() {
        marker.setIcon(scoreIconsHover[prop.score]);
    });

    marker.on('mouseout', function() {
        marker.setIcon(scoreIcons[prop.score]);
    });

    marker.on('click', async () => {
            const address = await getAddressFromPlacesAPI(prop.uprn, '{{ key }}');

            const popupContent = `
                <a href="/${prop.uprn}" style="color:blue; text-decoration:underline;">
                      ${address} 
                </a>
                <p>Hard to Heat Score: ${prop.score}
            `;
            marker.bindPopup(popupContent).openPopup();
        });

        markersPositions.push([prop.lat, prop.long]);
    }

    if (markersPositions.length > 0) {
        const bounds = L.latLngBounds(markersPositions);
        map.fitBounds(bounds);
    }
}

window.onload = initMap;
</script>

  {% endblock %}

{% endblock %}








